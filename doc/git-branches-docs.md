# Документация веток Git

## Активные ветки

### `dev` (главная рабочая ветка)
**Статус:** Active  
**Назначение:** Основная ветка для разработки  
**Последнее обновление:** Фаза 1 завершена

**История:**
- Интеграция PostgreSQL + Prisma
- Рефакторинг архитектуры (Controllers → Services → Repositories)
- Добавление валидации (Zod)
- Базовое тестирование (Jest + Supertest)
- Система логирования (Winston)

---

### `feature/phase-2-account-settings-refresh-tokens`
**Статус:** Merged → `dev`  
**Назначение:** Реализация задач 2.1 и 2.2 из Roadmap  
**Создана от:** `dev`  
**Дата создания:** 21.11.2024  
**Дата мержа:** 21.11.2024

**Выполненные задачи:**

#### 2.1 Функционал "Настройки аккаунта" ✅
**Backend:**
- Добавлены поля `bio` и `social_links` в модель User
- Создана таблица `RefreshToken`
- Реализован `AccountController` с 4 эндпоинтами
- Валидация через Zod
- 9 тестов (все проходят)

**Frontend:**
- Страница `SettingsPage` с вкладками
- `ProfileSettings` - редактирование профиля
- `SecuritySettings` - смена пароля, удаление аккаунта
- Роут `/settings`
- Кнопка "Настройки" в AccountPage

#### 2.2 Refresh-токены ✅
**Backend:**
- `TokenService` для работы с refresh-токенами
- Обновлён `AuthController` (4 новых эндпоинта)
- httpOnly cookies для безопасности
- 8 тестов (все проходят)

**Frontend:**
- Auto-refresh механизм в `api.ts`
- Обновлён `store.ts` для работы с refresh-токенами
- Функции `refreshAccessToken()` и `logout()`

**Коммиты:**
1. `feat: добавлен функционал настроек аккаунта и refresh-токенов (backend)`
2. `feat: добавлен frontend для настроек аккаунта`

---

### `feature/rbac-and-file-upload` (текущая)
**Статус:** Active (в работе)  
**Назначение:** Реализация задач 2.3 и 2.4 из Roadmap  
**Создана от:** `dev`  
**Дата создания:** 25.11.2024

**Выполненные задачи:**

#### 2.3 Ролевая модель доступа (RBAC) ✅
**Backend:**
- Добавлен enum `UserRole` (ADMIN, ARTIST, PREMIUM_USER, FREE_USER)
- Добавлено поле `role` в модель User
- Создан `rbac.middleware.ts`:
  - `requireRole()` - проверка роли
  - `requireSubscription()` - проверка подписки
  - `requireOwnership()` - проверка владения
  - Хелперы: `requireAdmin`, `requireArtist`
- Обновлён `auth.middleware.ts` (загрузка роли из БД)
- Миграция `add_user_roles`
- Тесты для RBAC
- Документация `RBAC_GUIDE.md`

**Frontend:**
- Добавлен тип `UserRole` в `types/index.ts`
- Обновлён интерфейс `BackendUser`

#### 2.4 Обработка загрузки файлов ✅
**Backend:**
- Установлен Multer
- Создан `upload.config.ts`:
  - Аватары (5MB, JPG/PNG/WEBP)
  - Обложки (10MB, JPG/PNG/WEBP)
  - Аудио (100MB, MP3/WAV/FLAC)
- Создан `upload.controller.ts`:
  - `POST /api/upload/avatar`
  - `POST /api/upload/cover`
  - `POST /api/upload/audio`
- Создан `upload.routes.ts` с RBAC защитой
- Раздача статических файлов `/uploads`
- Документация `FILE_UPLOAD_GUIDE.md`

**Frontend:**
- Функции в `api.ts`: `uploadAvatar()`, `uploadCover()`, `uploadAudio()`
- Компонент `AvatarUpload` (Drag & Drop, валидация, предпросмотр)
- Интеграция в `ProfileSettings`

**Коммиты:**
1. `feat: добавлена RBAC система и загрузка файлов (2.3 + 2.4)`

**Статистика:**
- Файлов изменено: 23
- Новых файлов: 11
- Новых тестов: 1
- Все тесты проходят ✅

**Готовность к мержу:** Да (после финального тестирования)

---

## Завершённые ветки

### `feature/phase-1-database-architecture`
**Статус:** Merged → `dev`  
**Назначение:** Фаза 1 из Roadmap  
**Дата создания:** ~15.11.2024  
**Дата мержа:** ~20.11.2024

**Выполненные задачи:**
- 1.1 Интеграция PostgreSQL + Prisma
- 1.2 Рефакторинг архитектуры бэкенда
- 1.3 Добавление валидации данных (Zod)
- 1.4 Базовое тестирование бэкенда
- 1.5 Система логирования (Winston)

---

## Планируемые ветки

### `feature/phase-3-ui-improvements`
**Статус:** Planned  
**Назначение:** Фаза 3 - Визуальные доработки UI  
**Будет создана от:** `dev` (после мержа текущей ветки)

**Планируемые задачи:**
- Редизайн карточек подписки
- Улучшение таблицы покупок
- Добавление прогресс-баров
- Улучшение мобильной версии
- Добавление анимаций

---

### `feature/phase-3-caching-optimization`
**Статус:** Planned  
**Назначение:** Фаза 3 - Кэширование и оптимизация  

**Планируемые задачи:**
- Интеграция Redis
- Кэширование часто запрашиваемых данных
- Rate Limiting
- API Documentation (Swagger)

---

## Правила работы с ветками

1. **Создание ветки:**
   ```bash
   git checkout dev
   git pull origin dev
   git checkout -b feature/<название-задачи>
   ```

2. **Коммиты:**
   - Частые коммиты с осмысленными сообщениями
   - Формат: `feat:`, `fix:`, `refactor:`, `test:`, `docs:`
   - На русском языке

3. **Перед мержем:**
   - Все тесты должны проходить
   - Код должен быть отформатирован
   - Обновить документацию (`doc/status.md`)

4. **Мерж в dev:**
   ```bash
   git checkout dev
   git merge feature/<название-задачи>
   git push origin dev
   ```

---

## История изменений

**25.11.2024:**
- Создана ветка `feature/rbac-and-file-upload`
- Завершены задачи 2.3 (RBAC) и 2.4 (Загрузка файлов)
- 1 коммит, 11 новых файлов
- Готова к мержу в `dev`

**21.11.2024:**
- Создана ветка `feature/phase-2-account-settings-refresh-tokens`
- Завершены задачи 2.1 и 2.2
- 2 коммита, 17 новых тестов
- Смержена в `dev`

**~20.11.2024:**
- Завершена Фаза 1
- Мерж `feature/phase-1-database-architecture` → `dev`

---

## Текущий статус проекта

**Завершено:**
- ✅ Фаза 0 (Hotfix)
- ✅ Фаза 1 (Critical)
- ✅ Фаза 2.1 (Настройки аккаунта)
- ✅ Фаза 2.2 (Refresh-токены)
- ✅ Фаза 2.3 (RBAC)
- ✅ Фаза 2.4 (Загрузка файлов)

**В работе:**
- Финальное тестирование задач 2.3 и 2.4

**Следующее:**
- Фаза 2.5 (CI/CD для бэкенда)
- Фаза 2.6 (Единая обработка ошибок)
- Фаза 3 (Nice-to-Have)
